---
- name: Installing openssh-sftp-server
  community.general.opkg:
    name: openssh-sftp-server
    state: present
  when: bpi_aditional_packages.openssh_sftp == "true"

- name: Install filesystem manipulation packages
  community.general.opkg:
    name:
      - kmod-nvme
      - mmc-utils
      - kmod-mtd-rw
      - kmod-fs-ext4
      - lsblk
      - parted
      - uvol
      - autopart
      - openssl-util
    state: present

- name: Installing rsyslog
  community.general.opkg:
    name:
      - rsyslog
    state: present
  when: bpi_aditional_packages.rsyslog == "true"

- name: Checking if modprobe detected the NVMe
  ignore_errors: true
  ansible.builtin.shell: |
    set -o pipefail
    lsblk | grep disk | grep -c nvme0n1
  register: bpi_nvme_detected
  changed_when: bpi_nvme_detected.rc != 0

# sometimes OpenWRT may fail to report the presence of the NVMe after modprobe, so we reboot.
- name: Rebooting in order to detect all the devices
  # since ansible.builtin.reboot does not notice when the system comes back and reports timeout
  ansible.builtin.command: "/sbin/reboot"
  async: 1
  poll: 0
  when: bpi_nvme_detected.stdout | int == 0
 
- name: Wait for reboot
  ansible.builtin.wait_for_connection:
    timeout: 300
    delay: 60
  when: bpi_nvme_detected.stdout | int == 0
